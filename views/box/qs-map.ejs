<script src='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.js'></script>
<script src='js/leaflet.polylineDecorator.min.js'></script>
<script src="js/d3.v3.min.js"></script>
<script src="js/colorbrewer.js"></script>
<link href='http://api.tiles.mapbox.com/mapbox.js/v1.3.1/mapbox.css' rel='stylesheet' />

<script src='data/qs_poi_bern.js'></script>
<script src='data/qs_path_bern.js'></script>

<style type="text/css">
#map { 
	position:absolute; 
	width: 100%; 
	height: 100%;
}
</style>

<div class="qs-box" id='map'></div>

<script type='text/javascript'>

var getActivityColor = d3.scale.ordinal().range(colorbrewer.Dark2[8]);

var map = L.mapbox.map('map', 'mrastan.map-yqc0qxly')
    .setView([46.945, 7.575], 12);
//map.dragging.disable();

// POI layer 
var markerLayer = L.mapbox.markerLayer().addTo(map);
markerLayer.on('layeradd', function(e) {
    var marker = e.layer,
        feature = marker.feature,
        coor = feature.geometry.coordinates;
        //img_url = 'http://maps.googleapis.com/maps/api/streetview?size=600x160&location=' + coor[1] + ',%20' + coor[0] + '&sensor=false' 

    var popupContent =  '<div class="popup">' +
                        //'<img src="' + img_url + '">' +
                        '   <h2>' + feature.properties.title + '</h2>' +
                        '</div>';

    marker.bindPopup(popupContent,{
        closeButton: false,
        minWidth: 50
    });
});
markerLayer.setGeoJSON(qs_poi_bern);

// path layer
var i = 0;
var geoPath = L.geoJson(qs_path_bern);

geoPath.eachLayer(function(layer) {
  var activity_color = getActivityColor(i++);

  var path = L.polyline(layer.getLatLngs(), {});
  var pathDeco = L.polylineDecorator(path, {
    patterns: [
            {offset: 0, repeat: 11, symbol: new L.Symbol.Dash({
                                                pixelSize: 0,
                                                pathOptions: {weight: 6, color: activity_color, opacity: 1}
                                              })}
        ]
  }).addTo(map);
});

// Cycle over markers
function cycle(markers) {
    var i = 0;
    function run() {
        if (++i > markers.length - 1) i = 0;
        //map.setView(markers[i].getLatLng(), 13);
        markers[i].openPopup();
        window.setTimeout(run, 3000);
    }
    run();
}

//cycle(markerLayer.getLayers());
</script>